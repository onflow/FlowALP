# FlowALPv0 Liquidation Mechanism

Note: This document was generated by Claude from a set of Slack threads and in-code documentation related to liquidation, then reviewed and edited by @jordanschalm, who is responsible for any inaccuracies.

## Overview

FlowALPv0 uses a two-tier system to protect against insolvent positions:
1. **Automatic rebalancing** (first line of defense) - proactively manages position health
2. **Liquidation** (second line of defense) - resolves unhealthy positions when rebalancing is insufficient

Liquidations should be relatively rare events, invoked only when automatic rebalancing fails to maintain position solvency.

## Key Concepts

### Effective Collateral & Debt

The effective collateral represents a risk-adjusted value of **deposited collateral**, denominated in MOET ($):
```
Ce = (Nc)(Pc)(Fc)
```

The effective debt represents a risk-adjusted value of **borrowed funds**, denominated in MOET ($):
```
De = (Nd)(Pd) / Fd
```

Where:
- `Ce/De` = Effective collateral / Debt ($)
- `Nc/Nd` = Number of collateral tokens / debt tokens
- `Pc/Pd` = Collateral / debt token price ($/token)
- `Fc/Fd` = Collateral / debt factor (0-1, representing risk discount)

The collateral and debt factors discount the value of collateral and inflate the value of debt, creating a safety buffer. For example, Fc=0.8 means only 80% of the collateral's market value counts toward the position's borrowing capacity. Fd=0.9 means debt is treated as if it's worth 1/0.9 = ~11% more than its market value for health calculations.

A collateral/debt factor close to 1 indicates a low-risk token, or a token with a low anticipated volatility. A collateral/debt factor closer to 0 indicates a high-risk token, or a token with a high anticipated volatility.

### Health Factor

The health factor is a measure of position solvency, using effective debt and collateral values. Since debt values are inflated and collateral values are discounted, a position which is slightly unhealthy still typically still be solvent in terms of market prices. This provides a buffer where the position can be liquidated without the protocol incurring any losses.

```
HF = Ce / De
```

- **HF > 1.0**: Healthy position (over-collateralized)
- **HF = 1.0**: Break-even point
- **HF < 1.0**: Unhealthy position (under-collateralized, eligible for liquidation)
- **HF = ∞**: No debt outstanding

## Automatic Rebalancing: First Line of Defense

Before liquidation becomes necessary, positions can configure automatic rebalancing via DeFiActions sources and sinks:

- **Top-up Source**: When a position falls below its `minHealth` threshold, the Pool automatically pulls funds from the configured source to restore health
- **Draw-down Sink**: When a position exceeds its `maxHealth` threshold, the Pool automatically pushes excess collateral to the configured sink

Positions that enable automatic rebalancing can avoid liquidation entirely, as the system proactively maintains their health within the configured range. **Note:** The specific `minHealth` threshold for rebalancing is distinct from the global liquidation trigger (HF < 1.0).

Automatic rebalancing may fail to maintain a position's health for several reasons:
- The position has not provided a top-up source
- The position has provided a top-up source, but it does not have sufficient withdrawable balance
- Collateral or debt prices moved too quickly for the periodic rebalancing process (implemented by Scheduled Transactions) to balance the position in time. (Rebalancing occurs on a best-effort basis.)

## Manual Liquidation: Second Line of Defense

When a position's health factor falls below 1.0 and cannot be restored through rebalancing, it becomes eligible for liquidation via the `manualLiquidation` function.

NOTE: This mechanism will be extended to include automated liquidation in the future (see `## Future Extensions` below)

### Liquidation Conditions

A liquidation is accepted if all of the following are met:

1. **Pre-liquidation health**: Position HF < 1.0
2. **Post-liquidation health**: After the liquidation, HF ≤ `liquidationTargetHF` (currently 1.05)
3. **Amount constraints**: Cannot repay more debt or seize more collateral than exists in the position
4. **Price constraints**: Liquidator must offer a better price than could be obtained from a DEX

**Important**: A liquidation need not _improve_ the health factor. If a position is insolvent (e.g., due to a large price drop), liquidations that reduce the position size but leave HF < 1.0 are still accepted. This prevents accumulation of bad debt in the case that the depreciating asset continues to depreciate.

### Liquidation Mechanics

The liquidator specifies:
- The debt token type to repay
- The collateral token type to seize
- The amount of collateral to seize
- A vault containing the repayment amount

The protocol:
1. Validates the position is unhealthy (HF < 1.0)
2. Calculates post-liquidation health using effective collateral/debt formulas
3. Ensures post-liquidation HF ≤ 1.05 (prevents over-liquidation)
4. Ensures the liquidation offers a better price than what is available from a DEX
5. Ensures the DEX price and Oracle price do not diverge by too large a margin
6. Deposits repayment to reserves and withdraws seized collateral
7. Returns seized collateral to the liquidator

## Incentive Mechanism

### Short Term

**No explicit incentive is provided.** The Flow Foundation will perform liquidations manually as needed during the initial deployment period. Since FlowALP is operated by Flow Foundation, any cost of liquidation is offset by the benefit of protecting the protocol's solvency.

### Long Term

Liquidations will occur automatically via DEX integration. The protocol will:
1. Automatically liquidate unhealthy positions by trading collateral for debt tokens on integrated DEXs
2. Accept manual liquidation offers from external parties **only if they provide a better price than the DEX**

In this model, no explicit incentive (liquidation bonus) is necessary. Liquidators can profit by:
- Accessing larger liquidity pools than the on-chain DEX
- Taking advantage of temporary DEX price inefficiencies
- Avoiding DEX slippage on large trades

The liquidator's incentive is implicit: they can acquire the position's collateral at a better rate than the DEX would offer, while the protocol benefits from receiving a better price than it could achieve through automated DEX liquidation.

## Future Extensions

### Automatic DEX Liquidation

A future update will add infrastructure for automatic liquidation via DEX. Like automatic rebalancing, this will be implemented using scheduled transactions.
